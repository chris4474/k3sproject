---
#
# reboot all nodes
#
- hosts: master
  gather_facts: yes
  tasks:

  - name: Update all hosts (Alpine)
    become: true
    ansible.builtin.apk:
      update_cache: true
      upgrade: yes
    when: ansible_os_family == "Alpine"

  - name: Update all hosts (Debian)
    become: true
    ansible.builtin.apt:
      update_cache: true
      upgrade: full
    when: ansible_os_family == "Debian"

  - name: Ensure the directory /usr/local/bin directory exists
    become: true
    file:
      path: /usr/local/bin  # The path of the directory to create
      state: directory

  - name: Install k3s Server
    become: true
    shell: |
       curl -sfL https://get.k3s.io | sh -

  - name: retrieve k3s.yaml
    become: true
    fetch: 
      src: /etc/rancher/k3s/k3s.yaml
      dest: "{{ lookup('env','HOME') }}/k3s.yaml"
      flat: yes
